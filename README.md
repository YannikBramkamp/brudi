# brudi

When it comes to backup-creation there are several solutions to use.
In general everybody's doing some sort of `dump` or `tar` and backing up the results incremental with [`restic`](https://github.com/restic/restic) or similar programs.

This is why `brudi` was born. `brudi` supports several backup-methods and is configurable by a simple `yaml` file.
The advantage of `brudi` is, that you can create a backup of a source of your choice and save it with `restic` aftwards in one step.
Under the hood, `brudi` uses the given binaries like `mysqldump`, `mongodump`, `tar` or `restic`.

Using `brudi` will save you from finding yourself writing bash-scripts to create your backups.

## Features

### Source backup methods

- [x] `mysqldump`
- [x] `mongodump`
- [x] `tar`

### Incremental backup of the source backups

- [x] `restic`
  - [ ] `commands`
    - [x] `restic backup`
    - [ ] `restic forget`
  - [x] `storage`
    - [x] `s3`

## Usage

### CLI

```shell
$ brudi --help

Easy, incremental and encrypted backup creation for different backends (file, mongoDB, mysql, etc.)
After creating your desired tar- or dump-file, brudi backs up the result with restic

Usage:
  brudi [command]

Available Commands:
  help        Help about any command
  mongodump   Creates a mongodump of your desired server
  mysqldump   Creates a mysqldump of your desired server
  tar         Creates a tar archive of your desired paths
  version     Print the version number of brudi

Flags:
      --cleanup         cleanup backup files afterwards
  -c, --config string   config file (default is ${HOME}/.brudi.yaml)
  -h, --help            help for brudi
      --restic          backup result with restic and push it to s3
      --version         version for brudi

Use "brudi [command] --help" for more information about a command.
```

### Configuration

As already mentioned, `brudi` is configured via `.yaml`. The default path for this file is `${HOME}/.brudi.yaml`, but it's adjustable via `-c` or `--config`.
Since the configuration provided by the `.yaml`-file is mapped to the corresponding CLI-flags, you can adjust literally every parameter of your source backup.  
Therefore you can simply refer to the official documentations for the available flags of your desired source. (`tar`, `mysqldump`, ...)

#### Sources

##### Tar

```yaml
tar:
  options:
    flags:
      create: true
      gzip: true
      file: /tmp/test.tar.gz
    paths:
      - /tmp/testfile
  hostName: autoGeneratedIfEmpty
```

Becomes the following command: `tar -c -z -f /tmp/test.tar.gz /tmp/testfile`
All available flags to be set in the `.yaml`-configuration can be found [here](pkg/source/tar/cli.go#L7).

##### MySQLDump

```yaml
mysqldump:
  flags:
    host: 127.0.0.1
    port: 3306
    password: mysqlroot
    user: root
    opt: true
    allDatabases: true
    resultFile: /tmp/test.sqldump
```

Becomes the following command: `mysqldump --all-databases --host=127.0.0.1 --opt --password=mysqlroot --port=3306 --result-file=/tmp/test.sqldump --user=root`
All available flags to be set in the `.yaml`-configuration can be found [here](pkg/source/mysqldump/cli.go#L7).

##### MongoDump

```yaml
mongodump:
  flags:
    username: root
    password: mongodbroot
    host: 127.0.0.1
    port: 27017
    gzip: true
    archive: /tmp/dump.tar.gz
```

Becomes the following command: `mongodump --host=127.0.0.1 --port=27017 --username=root --password=mongodbroot --gzip --archive=/tmp/dump.tar.gz`
All available flags to be set in the `.yaml`-configuration can be found [here](pkg/source/mongodump/cli.go#L7).

#### Restic

In case you're running your backup with the `--restic`-flag, you need to provide a [valid configuration for restic](https://restic.readthedocs.io/en/latest/030_preparing_a_new_repo.html).  
You can either configure `restic` via `brudi`s `.yaml`-configuration, or via the [environment variables](https://restic.readthedocs.io/en/latest/040_backup.html#environment-variables) used by `restic`.  

For now, it's only possible to use `restic` with an `S3` compatible backend or any other backend compatible with the env `RESTIC_REPOSITORY`.

```yaml
restic:
  bucketName: "my.s3.bucket"
  host: "filled with hostname of backup"
  accessKeyID: ""
  secretAccessKey: ""
  region: "your s3 endpoint"
  repository: "auto generated from bucketName and region if empty"
  password: "required"
```

#### Sensitive Data

In case you don't want to provide data directly in the `.yaml`-file, e.g. sensitive data like passwords, you can use environment-variables.
Each key of the configuration is overwritable via environment-variables. Your variable must specify the whole path to a key, seperated by `_`.  
Given this `.yaml`:

```yaml
mongodump:
  flags:
    username: "" # we will override this by env
    password: "" # we will override this by env
    host: 127.0.0.1
    port: 27017
    gzip: true
    archive: /tmp/dump.tar.gz
```

Set your env's:

```shell
export MONGODUMP_FLAGS_USERNAME="root"
export MONGODUMP_FLAGS_PASSWORD="mongodbroot"
```

As soon as a variable for a key exists in your environment, the value of this environment-variable is used in favour of your `.yaml`-config.
